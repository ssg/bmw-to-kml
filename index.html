<!DOCTYPE html>
<html lang="en">
<head>
    <!-- code initially generated by claude sonnet 4.5 - retouched later -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Convert BMW Drive Recorder metadata to KML format">
    <meta name="generator" content="Claude Sonnet 4.5" />
    <meta name="theme-color" content="#1a73e8">
    <title>BMW to KML Converter</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>üöó BMW to KML Converter</h1>
        <p class="subtitle">convert BMW Drive Recorder Metadata.json file to Google Earth KML format</p>
        
        <div class="drop-zone" id="dropZone">
            <div class="drop-icon">üìÅ</div>
            <div class="drop-text">Drop Metadata.json here</div>
            <div class="drop-hint">or click to browse</div>
        </div>

        <input type="file" id="fileInput" class="file-input" accept=".json">

        <div class="status" id="status"></div>
        
        <div class="information">
your data is processed on your browser, never sent to a third party.<br/>
you can install it as a PWA and use it locally and offline.
        </div>
    </div>

    <footer>
        copyright (c) 2026 <a href="https://github.com/ssg">sedat kapanoglu</a> 
        ¬∑ 
        <a href="https://github.com/ssg/bmw-to-kml">github</a>
    </footer>

    <script>
        // File handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function showStatus(message, type) {
            const STATUS_TIMEOUT_MS = 10000;
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, STATUS_TIMEOUT_MS);
            }
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.json')) {
                showStatus('Please select a JSON file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonContent = JSON.parse(e.target.result);
                    processJSON(jsonContent);
                } catch (error) {
                    showStatus(`Error parsing JSON: ${error.message}`, 'error');
                }
            };
            reader.onerror = () => {
                showStatus('Error reading file', 'error');
            };
            reader.readAsText(file);
        }

        function processJSON(jsonContent) {
            try {
                // Handle both array and object formats
                let entries;
                if (Array.isArray(jsonContent)) {
                    entries = jsonContent[0]?.entries;
                } else {
                    entries = jsonContent.entries;
                }
                
                if (!entries || entries.length === 0) {
                    showStatus('No entries found in metadata', 'error');
                    return;
                }

                showStatus(`Processing ${entries.length} entries...`, 'info');

                // Parse event date from first entry
                const firstEntry = entries[0];
                const eventDate = new Date(firstEntry.date);
                const eventDateStr = eventDate.toISOString().split('T')[0];

                // Generate KML
                const kml = generateKML(entries, eventDateStr);

                // Download KML
                downloadKML(kml, `${eventDateStr}.kml`);

                // Count unique coordinates
                let uniqueCount = 0;
                let lastLon = null;
                let lastLat = null;
                for (const entry of entries) {
                    if (entry.longitude !== lastLon || entry.latitude !== lastLat) {
                        uniqueCount++;
                        lastLon = entry.longitude;
                        lastLat = entry.latitude;
                    }
                }

                showStatus(
                    `‚úì KML file created! ${uniqueCount} unique points from ${entries.length} entries`,
                    'success'
                );
            } catch (error) {
                showStatus(`Error processing file: ${error.message}`, 'error');
            }
        }

        function generateKML(entries, eventDateStr) {
            const kmlHeader = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <!-- generated by BMWtoKML - https://github.com/ssg/bmw-to-kml - copyright (c) 2026 sedat kapanoglu -->
  <Document>
    <name>Driving on ${eventDateStr}</name>
    <description>GPS path from BMW Drive Recorder</description>
    
    <!-- Style for the path line -->
    <Style id="pathStyle">
      <LineStyle>
        <color>ff0000ff</color>
        <width>4</width>
      </LineStyle>
    </Style>
    
    <!-- Style for placemarks -->
    <Style id="pointStyle">
      <IconStyle>
        <color>ff00ff00</color>
        <scale>0.5</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <!-- Path LineString -->
    <Placemark>
      <name>Route</name>
      <styleUrl>#pathStyle</styleUrl>
      <LineString>
        <extrude>0</extrude>
        <tessellate>1</tessellate>
        <altitudeMode>clampToGround</altitudeMode>
        <coordinates>
`;

            // Build coordinates string - remove consecutive duplicates
            const coordinates = [];
            let lastLon = null;
            let lastLat = null;
            
            for (const entry of entries) {
                const lon = entry.longitude;
                const lat = entry.latitude;
                const alt = 0;
                
                if (lon !== lastLon || lat !== lastLat) {
                    coordinates.push(`          ${lon},${lat},${alt}`);
                    lastLon = lon;
                    lastLat = lat;
                }
            }

            const coordinatesString = coordinates.join('\n');

            const kmlMiddle = `
        </coordinates>
      </LineString>
    </Placemark>
    
    <!-- Individual Points with Speed and Time Data -->
`;

            // Build placemarks
            const placemarks = entries.map(entry => {
                const speedKmh = entry['velocity_KM/H'] || 0;
                const speedMph = entry['velocity_MP/H'] || 0;
                
                return `
    <Placemark>
      <name>${entry.time}: ${Math.round(speedMph)}mp/h</name>
      <description><![CDATA[
        <section style="display:flex; flex-shrink: 0; justify-content:space-between">
            <section style="display:inline-block; margin-right: 40px">
                <code>#${entry.id}</code>
            </section>
            <section style="display:inline-block;">
                <code>${entry.date} ${entry.time}</code>
            </section>
        </section>
        <section style="display: inline-block; margin-right:40px; text-align:center">
            <br />
            <span style="font-size: 3em">${Math.round(speedMph)}</span>
            <br />
            mp/h
        </section>
        <section style="display: inline-block; ; text-align:center">
            <br />
            <span style="font-size: 3em">${Math.round(speedKmh)}</span>
            <br />
            km/h
        </section>
      ]]></description>
      <styleUrl>#pointStyle</styleUrl>
      <Point>
        <coordinates>${entry.longitude},${entry.latitude},0</coordinates>
      </Point>
    </Placemark>`;
            }).join('');

            const kmlFooter = `
  </Document>
</kml>`;

            return kmlHeader + coordinatesString + kmlMiddle + placemarks + kmlFooter;
        }

        function downloadKML(kmlContent, filename) {
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
